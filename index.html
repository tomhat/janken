<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css"  />
<!--[if lt IE 9]>
<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<style type="text/css">  
<!--
.selectButton{
	border:solid 3px red;
}
-->
</style>
<script type="text/javascript">
(function(w,d){
	let $ = w.jQuery;
	d.addEventListener('DOMContentLoaded',function(){
		var gameState = 'select';

		var enumGu    = 0;
		var enumChoki = 1;
		var enumPa    = 2;

		var enumWin   = 1;
		var enumLose  = -1;
		var enumDraw  = 0;

		var flagContinueWin = false;

		var numContinueWin = 0;
		var numWin = 0;
		var numLose = 0;

		var currentContinueWin = 0;

		d.getElementById('button_start').addEventListener('click',function(e){
			initGame();
		});
		d.getElementById('button_your_gu').addEventListener('click',function(e){
			if( gameState != 'select' ) return; 
			var cpuSelected = selectCPUGuChokiPa();
			gameState = 'result';
			dispSelectGuChoPa(0,enumGu);
			dispSelectGuChoPa(1,cpuSelected);
			dispResult(checkWinLose(enumGu,cpuSelected));
		});
		d.getElementById('button_your_choki').addEventListener('click',function(e){
			if( gameState != 'select' ) return; 
			var cpuSelected = selectCPUGuChokiPa();
			gameState = 'result';
			dispSelectGuChoPa(0,enumChoki);
			dispSelectGuChoPa(1,cpuSelected);
			dispResult(checkWinLose(enumChoki,cpuSelected));
		});
		d.getElementById('button_your_pa').addEventListener('click',function(e){
			if( gameState != 'select' ) return; 
			var cpuSelected = selectCPUGuChokiPa();
			gameState = 'result';
			dispSelectGuChoPa(0,enumPa);
			dispSelectGuChoPa(1,cpuSelected);
			dispResult(checkWinLose(enumPa,cpuSelected));
		});

		$('.next').bind('click',function(){
			initGame();
		});

		var initTitle = function initTitle(){
			$('.disp_view').hide();
			$('#view_menu').show();
		};

		var initGame = function initGame(){
			$('.disp_view').hide();
			$('#view_game').show();

			$('.disp_msg').hide();
			$('#msg_ready').show();
			gameState = 'select';
			$('.button_your').removeClass('selectButton');
			$('.button_cpu').removeClass('selectButton');
			if( flagContinueWin && currentContinueWin > 1 ){
				$('#current_continue_win').text(currentContinueWin+"連勝中");
				$('#msg_continue_win').show();
			}else{
				$('#msg_continue_win').hide();
			}
		};


		//Side: 0 your
		//      1 cpu
		var dispSelectGuChoPa = function dispSelectGuChoPa(side,select){
			var targetClass = '.button_your';
			var target = 'button_your_';
			if( side == 1 ){
				target = 'button_cpu_';
				targetClass = '.button_cpu';
			}
			if( select == enumGu ){
				target += 'gu';
			}else if( select == enumChoki ){
				target += 'choki';
			}else{
				target += 'pa';
			}
			$(targetClass).removeClass('selectButton');
			$('#'+target).addClass('selectButton');
		}

		var dispResult = function dispResult(result){
			$('.disp_msg').hide();
			if( result == 0 ){
				//Drawsi
				$('#msg_draw').show();
			}else if( result > 0 ){
				//Win
				$('#msg_win').show();
				numWin++;
				if( flagContinueWin ){
					currentContinueWin++;
				}else{
					flagContinueWin = true;
					currentContinueWin = 1;
				}
			}else{
				//Lose
				$('#msg_lose').show();
				numLose++;
				flagContinueWin = false;
				if( numContinueWin < currentContinueWin ){
					numContinueWin = currentContinueWin;
				}
				currentContinueWin = 0;
			}
		};

		var updateDisplay = function updateDisplay(){
		};


		// Win: 1
		// Lose: -1
		// Draw: 0
		var checkWinLose = function checkWinLose(your,cpu){
			var winLoseHash = {
				0:{
					0:0,
					1:1,
					2:-1
				},
				1:{
					0:-1,
					1:0,
					2:1
				},
				2:{
					0:1,
					1:-1,
					2:0
				}
			}
			return winLoseHash[your][cpu];
		}

		var selectCPUGuChokiPa = function selectCPUGuChokiPa(){
			return enumGu;
		};

		initTitle();
	});

})(window,document);
</script>
<title>JanKen Game</title>
</head>
<body>
	<h1>じゃんけんゲーム</h1>
	<div class="disp_view" id="view_menu">
		<div>
			<p>これまでの戦績「<span id="num_win">0</span>勝<span id="num_lose">0</span>負」</p>
			<p>最高連勝記録「<span id="num_continue_win">0</span>連勝」</p>
			<button id="button_start">ゲームスタート</button>
		</div>
	</div>
	<div class="disp_view" id="view_game">
		<div>
			<p class="disp_msg" id="msg_ready">じゃんけん…</p>
			<p class="disp_msg" id="msg_win">ぽん！あなたの勝ちです。<button class="next">次へ</button></p>
			<p class="disp_msg" id="msg_lose">ぽん！あなたの負けです。<button class="next">次へ</button></p>
			<p class="disp_msg" id="msg_draw">ぽん！あいこです。 <button class="next">次へ</button></p>
			<fieldset>
			<legend>相手</legend>
			<button class="button_cpu" id="button_cpu_gu" disabled><img src="./assets/gu.png" alt="グー" /></button>
			<button class="button_cpu" id="button_cpu_choki" disabled><img src="./assets/choki.png" alt="チョキ" /></button>
			<button class="button_cpu" id="button_cpu_pa" disabled><img src="./assets/pa.png" alt="パー" /></button>
			</fieldset>
			<fieldset>
			<legend>あなた</legend>
			<p>【選んでください】</p>
			<button class="button_your" id="button_your_gu"><img src="./assets/gu.png" alt="グー" /></button>
			<button class="button_your" id="button_your_choki"><img src="./assets/choki.png" alt="チョキ" /></button>
			<button class="button_your" id="button_your_pa"><img src="./assets/pa.png" alt="パー" /></button>
			</fieldset>
			<p id="msg_continue_win"><span id="current_continue_win">0<span>連勝中</p>
		</div>
	</div>
</body>
</html>
